<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Blog | New Blog</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
          content="Bạn hãy chia sẻ những điều bổ ích nhé">
    <meta name="keywords" content="HTML,CSS,XML,JavaScript">
    <meta name="author" content="Đoàn Đức Tín">
    <meta property="og:image"
          content="https://png.pngtree.com/thumb_back/fh260/background/20191009/pngtree-geometric-abstract-background-with-blogs-image_318758.jpg"/>
    <th:block th:insert="Common/_css :: content"/>

    <!-- Custom -->
    <link rel="stylesheet" th:href="@{/Resource/blogsite/style.css}">
    <style>
        .single-blog-post:hover{
            box-shadow: 0 1px 5px rgba(0, 0, 0, .6);
        }
        .ftco-navbar-light{
            position: absolute;
            background-color: transparent !important;
        }
        .fa-angle-left{
            margin-left: 12px;
            padding: 0;
            text-align: left;
        }
        .fa-angle-right{
            margin-left: 12px;
            padding: 0;
            text-align: left;
        }
        .fa-angle-up{
            padding: 0;
            margin: 0;
        }
        .input-image-hidden{

        }
        .myerror{
            font-family: Arial, Baskerville, monospace;
            font-weight: 700;
            color: red;
            font-size: 10px;
        }
        @media (max-width: 600px) {
            .input-image-hidden{
                display: none;
            }
        }
    </style>
    <script src="https://cdn.tiny.cloud/1/90qladyecfroqnj6mllsoy294bi49oudx9kgkzjyviz3a090/tinymce/5/tinymce.min.js" referrerpolicy="origin"></script>

</head>
<body>

<th:block th:insert="Common/header :: content"/>
<th:block th:insert="Common/topcontent_blog :: content"/>

<div class="main-content-wrapper section-padding-100">
    <div class="container-fluid">
        <div class="row justify-content-center">

            <!--CONTENT BLOG-->
            <div id="new-section" class="col-12 col-lg-9">

                <!--LEFT -> WRITE BLOG-->
                <div class="title">
                    <h5 style="font-weight: 700;font-family: Dosis, serif">Tạo bài viết mới</h5>
                    <hr>
                </div>

                <div class="post-a-comment-area" style="padding-right:0;padding-left: 0">
                    <form id="blog-form" method="post">

                        <div style="padding-left: 20px;padding-right: 20px">
                            <h5>Thông tin cơ bản</h5>
                            <div class="row">
                                <div class="col-12">
                                    <div class="group">
                                        <input type="text" name="blog-title" required>
                                        <span class="highlight"></span>
                                        <span class="bar"></span>
                                        <label>Nhập tiêu đề bài viết (20-69 chữ cái)&nbsp;
                                            <span class="myerror" id="error-title-1" style="display: none">* Đảm bảo độ dài</span>
                                            <span class="myerror" id="error-title-2" style="display: none">* Không chứa dấu đặc biệt như ngoặc đơn, ngoặc kép,...</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label id="error-image" for="input-blog-thumb" class="btn btn-outline-primary" style="font-size: 13px;font-weight: 700;">Chọn ảnh giới thiệu</label>
                                </div>
                                <div class="col-6">
                                    <div class="group">
                                        <input onchange="previewFile()" accept="image/jpeg,image/jpg,image/png,video/mp4,video/mkv" id="input-blog-thumb" class="input-image-hidden" type="file" name="blogthumb" required style="overflow-x: hidden">
                                        <span class="highlight"></span>
                                        <span class="bar"></span>
                                    </div>
                                </div>
                            </div>
                            <span id="error-image-1" class="myerror" style="display: none">* Ảnh giới thiệu phải có định dạng phù hợp và nhỏ hơn 30mb</span>
                            <div class="row justify-content-center">
                                <div class="col-12">
                                    <img id="preview-thumb" style="width: 70%;max-height: 500px">
                                </div>
                            </div>
                            <br><br>
                            <div class="row">
                                <div class="col-12">
                                    <div class="group">
                                        <textarea name="blog-des" required></textarea>
                                        <span class="highlight"></span>
                                        <span class="bar"></span>
                                        <label>Tóm tắt ngắn gọn về bài viết (20-5000 chữ cái)&nbsp;
                                            <span class="myerror" id="error-des-1" style="display: none">* Đảm bảo độ dài</span>
                                            <span class="myerror" id="error-des-2" style="display: none">* Không chứa dấu đặc biệt như ngoặc đơn, ngoặc kép,...</span>  </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-8">
                                    <div class="group">
                                        <input type="text" name="blog-name" required>
                                        <span class="highlight"></span>
                                        <span class="bar"></span>
                                        <label>Định danh bài viết (*) (bất kỳ 20-69 chữ cái)&nbsp;
                                            <span class="myerror" id="error-name-1" style="display: none">* Đảm bảo độ dài</span>
                                            <span class="myerror" id="error-name-2" style="display: none">* Chỉ cho phép chữ không dấu và chữ số</span>
                                            <span class="myerror" id="error-name-3" style="display: none">* Link này đã được sử dụng, bạn hãy chọn một tên khác</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="group">
                                        <input type="text" name="blog-category" required>
                                        <span class="highlight"></span>
                                        <span class="bar"></span>
                                        <label>Chủ đề bài viết (bất kỳ 1-10 chữ cái)&nbsp;
                                            <span class="myerror" id="error-category-1" style="display: none">* Đảm bảo độ dài</span>
                                            <span class="myerror" id="error-category-2" style="display: none">* Không chứa chữ đặc biệt</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <p style="color: grey;font-weight: 600;font-size: 10px">(*) Định danh bài viết là đường link bạn muốn hiển thị khi truy cập vào blog thay cho id (nhằm mục đích dễ nhớ), bạn có thể đặt bất kỳ tên gì, ví dụ một số định danh: 'hashmap trong java la gi', 'lap trinh huong doi tuong', 'chia khoa thanh cong', ...</p>
                        </div>

                        <br>

                        <div style="padding-left: 20px;padding-right: 20px">
                        <h5>Nội dung chính (ít nhất 80 từ)</h5>
                        <span class="myerror" id="error-text" style="display: none">* Bài viết của bạn quá ngắn, hãy tiếp tục viết thêm nhé</span>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="group">
                                    <input type="hidden" id="blog-editor" name="blog-editor">
                                    <textarea id="blog-content" required></textarea>
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                </div>
                            </div>
                        </div>
                        <br>

                        <div style="padding-left: 20px;padding-right: 20px">
                        <h5>Thông tin liên hệ</h5>
                        <div class="row">
                            <div class="col-12 col-md-6">
                                <div class="group">
                                    <input type="text" name="name">
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                    <label>Họ và tên (có thể để trống)</label>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="group">
                                    <input type="text" name="email">
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                    <label>Email (có thể để trống)</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="group">
                                    <textarea name="comment"></textarea>
                                    <span class="highlight"></span>
                                    <span class="bar"></span>
                                    <label>Ghi chú (có thể để trống)</label>
                                </div>
                            </div>
                        </div>
                        </div>

                    </form>

                </div>

                <br><br><br>

            </div>

            <!--ASIDE-->
            <div class="col-12 col-md-6 col-lg-3">
                <div class="post-sidebar-area wow fadeInUpBig" data-wow-delay="0s">

                    <!--FUNCTION-->
                    <div class="sidebar-widget-area">
                        <h5 class="title">Thao tác</h5>
                        <div class="widget-content" style="width: 100%">

                            <!--BUTTON MANAGER BLOGS-->
                            <th:block th:if="${session.user != null}">
                                <th:block th:if="${session.user.id != 4}">
                                    <a th:href="'/blog/manager'+${session.user.uName}" ><button class="btn btn-outline-primary" style="font-size: 12px;font-weight: 700;margin-bottom: 3px">Quản lý bài</button></a>
                                </th:block>
                                <th:block th:if="${session.user.id == 4}">
                                    <a><button class="btn btn-secondary disabled" style="font-size: 12px;font-weight: 700;margin-bottom: 3px">Quản lý bài</button></a>
                                </th:block>
                            </th:block>
                            <th:block th:if="${session.user == null}">
                                <a><button class="btn btn-secondary disabled" style="font-size: 12px;font-weight: 700;margin-bottom: 3px">Quản lý bài</button></a>
                            </th:block>

                            <hr>

                            <!--BUTTON SAVE DRAFT-->
                            <th:block th:if="${session.user != null}">
                                <th:block th:if="${session.user.id != 4}">
                                    <a><button class="btn btn-outline-primary" style="font-size: 12px;font-weight: 700;margin-bottom: 3px" onclick="submitDraft(this)">Lưu bản nháp mới</button></a>
                                </th:block>
                                <th:block th:if="${session.user.id == 4}">
                                    <a><button class="btn btn-secondary disabled" style="font-size: 12px;font-weight: 700;margin-bottom: 3px" onclick="infoSubmitDraft(this)">Lưu bản nháp mới</button></a>
                                </th:block>
                            </th:block>
                            <th:block th:if="${session.user == null}">
                                <a><button class="btn btn-secondary disabled" style="font-size: 12px;font-weight: 700;margin-bottom: 3px" onclick="infoSubmitDraft(this)">Lưu bản nháp mới</button></a>
                            </th:block>

                             <a><button class="btn btn-outline-success" style="font-size: 12px;font-weight: 700;margin-bottom: 3px" onclick="submitBlog(this)">Lưu và yêu cầu duyệt</button></a>

                            <hr>
                            <a href="/blog"><button class="btn btn-success" style="border:0;background: linear-gradient(to right, #009fff, #ec2f4b);font-size: 12px;font-weight: 700;margin-bottom: 3px">TRENDING BLOGS</button></a>

                        </div>
                    </div>

                    <!--TOP BLOG-->
                    <div class="sidebar-widget-area">
                        <h5 class="title">Blog nhiều lượt xem nhất</h5>
                        <div class="widget-content">

                            <th:block th:each="i:${TopViewBlogList}">
                                <div th:onclick="goto('/blog/[(${i.name})]')" class="single-blog-post post-style-2 d-flex align-items-center widget-post" style="height: 80px">

                                    <div class="post-thumbnail">
                                        <img th:src="${i.image}" alt="" style="max-height: 80px;">
                                    </div>

                                    <div class="post-content">
                                        <a href="#" class="headline">
                                            <h5 class="mb-0" style="font-family:'Work Sans','sans-serif'">[(${i.title})]</h5>
                                        </a>
                                    </div>
                                </div>
                            </th:block>

                        </div>
                    </div>

                    <!--EXTERNAL LINK-->
                    <div class="sidebar-widget-area">
                        <h5 class="title">Liên hệ với người duyệt bài</h5>
                        <div class="widget-content" style="width: 80%">
                            <div class="social-area d-flex justify-content-between">
                                <a target="_blank" href="https://www.facebook.com/FStatic-Community-101530871837182"><i class="fa fa-facebook"></i>FSTATIC</a>
                                <a target="_blank" href="https://www.facebook.com/Anhtpde140084"><i class="fa fa-facebook"></i>MOD_TPA</a>
                                <a target="_blank" href="https://www.facebook.com/satfomacej"><i class="fa fa-facebook"></i>ADMIN</a>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

<th:block th:insert="Common/_js :: content"/>
<th:block th:insert="Common/footer :: content"/>

<!-- Custom -->
<script th:src="@{/Resource/blogsite/js/jquery/jquery-2.2.4.min.js}"></script>
<script th:src="@{/Resource/blogsite/js/popper.min.js}"></script>
<script th:src="@{/Resource/blogsite/js/bootstrap.min.js}"></script>
<script th:src="@{/Resource/blogsite/js/plugins.js}"></script>
<script th:src="@{/Resource/blogsite/js/active.js}"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-23581568-13"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-23581568-13');
    document.getElementById('drop-fpt-all').addEventListener('click',()=>{
        x=document.getElementById('header-dropdown-menu');
        y=document.getElementById('header-dropdown-content');
        if (x.classList.contains('show')){
            x.classList.remove('show');
            y.classList.remove('show');
        }else{
            x.classList.add('show');
            y.classList.add('show');
        }
    })
    x=document.getElementById('drop-btn-login');
    if (x!==null) x.addEventListener('click',()=>{
        if (document.getElementById('drop-menu-login').classList.contains('show')){
            document.getElementById('drop-menu-login').classList.remove('show');
        }else{
            document.getElementById('drop-menu-login').classList.add('show');
        }
    })
</script>

<!--Function-->
<script>
    function goto(x){
        window.location=x;
    }
    function previewFile() {
        x=document.getElementById('error-image');
        x.classList.remove('btn-outline-danger');
        x.classList.add('btn-outline-primary');
        x.innerText='Chọn ảnh giới thiệu';
        const preview = document.getElementById("preview-thumb");
        const file = document.getElementById("input-blog-thumb").files[0];
        const reader1 = new FileReader();
        reader1.addEventListener("load", function () {
            preview.src = reader1.result;
        }, false);

        if (file) {
            reader1.readAsDataURL(file);
        }
    }
    function displayError(s) {
        hiddenError();
        const tmp=s.split('|');
        for (let i=0;i<tmp.length;i++){
            switch (tmp[i].toString()) {
                case "NAME_FORMAT_WRONG":document.getElementById('error-name-2').style.display='';break;
                case "TITLE_FORMAT_WRONG":document.getElementById('error-title-2').style.display='';break;
                case "DES_FORMAT_WRONG":document.getElementById('error-des-2').style.display='';break;
                case "CATEGORY_FORMAT_WRONG":document.getElementById('error-category-2').style.display='';break;
                //------
                case "NAME_LENGTH_WRONG":document.getElementById('error-name-1').style.display='';break;
                case "TITLE_LENGTH_WRONG":document.getElementById('error-title-1').style.display='';break;
                case "DES_LENGTH_WRONG":document.getElementById('error-des-1').style.display='';break;
                case "CATEGORY_LENGTH_WRONG":document.getElementById('error-category-1').style.display='';break;
                case "TEXT_LENGTH_WRONG":document.getElementById('error-text').style.display='';break;
                //------
                case "BLOG_NAME_EXITS":document.getElementById('error-name-3').style.display='';break;
                case "THUMB_NOT_ACCEPTED":
                    document.getElementById('error-image-1').style.display='';
                    x=document.getElementById('error-image');
                    x.classList.remove('btn-outline-primary');
                    x.classList.add('btn-outline-danger');
                    x.innerText='Kiểm tra lại tệp này';
                    break;
                default:break;
            }
        }
    }
    function hiddenError(){
        document.querySelectorAll('.myerror').forEach(e => e.style.display='none')
        x=document.getElementById('error-image');
        x.classList.remove('btn-outline-danger');
        x.classList.add('btn-outline-primary');
        x.innerText='Chọn ảnh giới thiệu';
    }
</script>

<!--API-->
<script>
    function infoSubmitDraft() {
        Swal.fire({
            position: 'top-end',
            icon: 'error',
            title: 'Tính năng không khả dụng',
            text: 'Bạn nên đăng nhập bằng tài khoản thật để lưu bản nháp mới',
            showConfirmButton: false,
            timer: 3000
        })
    }
</script>
<th:block th:if="${session.user != null}">
    <th:block th:if="${session.user.id != 4}">
        <script type="text/javascript" th:inline="javascript">
        function submitDraft(a) {
            if (a.innerHTML !== 'Lưu bản nháp mới') return;
            a.innerHTML = '<i class="fa fa-circle-o-notch fa-spin" style="padding: 0;margin: 0"></i>\n';
            document.getElementById('blog-editor').value=tinyMCE.activeEditor.getContent();
            var formData = new FormData(document.getElementById("blog-form"));
            $.ajax({
                type: 'POST',
                url: '/blog/api/add/draft',
                contentType: false,
                processData: false,
                //contentType: 'application/json',
                data: formData,
            }).done(function (result) {
                if (result.toString().substring(0, 7) === "//ERROR") {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'error',
                        title: "Có lỗi xảy ra, copy để tránh mất bài",
                        text: "Kiểm tra các nội dung nhập vào (báo đỏ)",
                        showConfirmButton: false,
                        timer: 4000
                    })
                    displayError(result.toString().substring(7));
                } else {
                    Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: "Nội dung đã được lưu",
                        text: "Bạn có thể tiếp tục chỉnh sửa bản nháp này tại mục Quản lí bài",
                        showConfirmButton: false,
                        timer: 4000,
                        timerProgressBar: true,
                        allowClickOutside: false,
                        allowOutsideClick: false,
                        willOpen: () => {
                            Swal.showLoading()
                        },
                        willClose: () => {
                            clearInterval(timerInterval)
                        }
                    }).then((result) => {
                        window.location='/blog/manager/'+[[${session.user.uName}]]
                    })
                }
                a.innerHTML='Lưu bản nháp mới';
            });
        }
        </script>
    </th:block>
</th:block>
<script>
        function submitBlog(a) {
            if (a.innerHTML !== 'Lưu và yêu cầu duyệt') return;
            a.innerHTML = '<i class="fa fa-circle-o-notch fa-spin" style="padding: 0;margin: 0"></i>&nbsp;Đang xử lí';
            document.getElementById('blog-editor').value=tinyMCE.activeEditor.getContent();
            var formData = new FormData(document.getElementById("blog-form"));
            Swal.fire({
                width:700,
                title: 'Khi đăng bài, bạn sẽ đồng ý với những điều sau',
                html: "<div style=\"overflow-y: scroll;display: block;height: 300px;text-align: left;\">" +
                    "<div class='card'><p class='card-body' style='font-family: Arial, Baskerville, monospace'> Nội dung bạn đăng nên là một nội dung lành mạnh và có giá trị, hạn chế copy từ nơi khác và không nên chèn ảnh vào bài viết bằng cách ctrl c -> ctrl v ảnh từ nguồn khác), để bài viết được duyệt, hãy đảm bảo tránh những nội dung mang tính xúc phạm đến danh dự của một tập thể, một cá nhân, nội dung sai sự thật, nội dung thiếu tính sáng tạo,...</p></div>" +
                    "<div class='card'><p class='card-body' style='font-family: Arial, Baskerville, monospace'> Khi bài viết được duyệt, nó sẽ trở thành sản phẩm của hệ thống nhưng tác giả của bài viết vẫn là bạn, bạn có quyền yêu cầu xóa hoặc ẩn quyền tác giả của mình cho bài viết đó nhưng không thể sửa đổi nội dung hoặc xóa bài viết này.</p></div>" +
                    "<div class='card'><p class='card-body' style='font-family: Arial, Baskerville, monospace'>  Nếu bạn cố sửa đổi những nội dung đã được duyệt trong bài viết, hệ thống sẽ thực hiện quy trình như sau: (1) Tạo bài viết mới B với nội dung đã được sửa từ bài viết A, (2) Admin sẽ so sánh nội dung của cả 2 bài viết A và B, (3) Admin có thể hủy hoặc duyệt bài viết B, (4) Nếu bài viết B được duyệt, lượt xem, lượt rate, comment, tên định danh của bài viết B sẽ được cập nhật giống như bài viết A, sau đó bài viết A sẽ bị ngưng kích hoạt.</p></div></div>",
                icon: 'warning',
                showCancelButton: true,
                showConfirmButton:true,
                confirmButtonText: 'Tôi đồng ý',
                allowClickOutside:false,
                allowOutsideClick:false
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        type: 'POST',
                        url: '/blog/api/add',
                        contentType: false,
                        processData: false,
                        //contentType: 'application/json',
                        data: formData,
                    }).done(function (result) {
                        if (result.toString().substring(0, 7) === "//ERROR") {
                            Swal.fire({
                                position: 'top-end',
                                icon: 'error',
                                title: "Có lỗi xảy ra, copy để tránh mất bài",
                                text: "Kiểm tra các nội dung nhập vào (báo đỏ)",
                                showConfirmButton: false,
                                timer: 4000
                            })
                            displayError(result.toString().substring(7));
                        } else {
                            Swal.fire({
                                position: 'top-end',
                                icon: 'success',
                                title: "Nội dung đã được lưu",
                                text: "Bài viết của bạn đang chờ duyệt trước khi lên trang chủ",
                                showConfirmButton: false,
                                timer: 4000
                            })
                        }
                        a.innerHTML='Lưu và yêu cầu duyệt';
                    });
                }else
                    a.innerHTML='Lưu và yêu cầu duyệt';
            })
        }
</script>

<!--Editor-->
<script>
    tinymce.init({
        height: 700,
        selector: '#blog-content',
        plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak searchreplace code wordcount codesample charmap',
        toolbar: 'undo redo | styleselect | forecolor backgroundcolor | bold italic | alignleft aligncenter alignright alignjustify | outdent indent | link charmap image | code codesample | searchreplace',
        toolbar_mode: 'floating'
    });
    document.querySelector('.owl-stage-outer').style.height='260px';
    document.getElementById('scrollUp').style.left='30px';
</script>

</body>
</html>